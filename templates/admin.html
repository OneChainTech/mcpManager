<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>é‡‘èæœåŠ¡MCPç®¡ç†å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      tailwind.config = { theme: { extend: { colors: { 'finance-blue': '#1e40af', 'finance-green': '#059669', 'finance-gold': '#d97706' } } } };
    </script>
  </head>
  <body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-slate-800">é‡‘èæœåŠ¡MCPç®¡ç†å¹³å°</h1>
      </div>

      <!-- æœåŠ¡ç›‘æ§åŒºåŸŸï¼ˆé»˜è®¤æ”¶èµ·ï¼‰ -->
      <div class="bg-white rounded-2xl shadow p-6 border border-gray-100 mb-8">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-r from-finance-gold to-orange-500 text-white flex items-center justify-center text-sm font-bold">ğŸ“Š</div>
            <h2 class="text-xl font-semibold text-slate-800">æœåŠ¡ç›‘æ§</h2>
          </div>
          <div class="flex items-center gap-2">
            <button id="refreshMonitoring" class="px-3 py-1.5 rounded bg-blue-600 text-white text-sm hover:bg-blue-700 transition-colors hidden">åˆ·æ–°</button>
            <button id="toggleMonitoring" class="px-3 py-1.5 rounded bg-blue-600 text-white text-sm hover:bg-blue-700 transition-colors">
              <span id="toggleMonitoringText">å±•å¼€</span>
            </button>
          </div>
        </div>
        <div id="monitoringContent" class="hidden mt-6">
          <!-- æœåŠ¡ç›‘æ§æ€»è§ˆ -->
          <div class="bg-gray-50 rounded-lg p-4">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                  <h4 class="font-medium text-slate-800">MCPæœåŠ¡çŠ¶æ€</h4>
                  <div id="mcpServiceStatus" class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-gray-400"></div>
                    <span class="text-sm text-slate-600">æ£€æŸ¥ä¸­...</span>
                  </div>
                </div>
                <div class="text-sm text-slate-600">
                  æ€»è°ƒç”¨æ¬¡æ•°: <span id="totalCalls" class="font-semibold text-slate-800">0</span>
                </div>
              </div>
              <div class="text-sm text-slate-500">
                æœ€åæ›´æ–°: <span id="lastUpdate">--</span>
              </div>
            </div>
            <div class="relative">
              <div class="overflow-x-auto">
                <div class="h-64 min-w-[600px]">
                  <canvas id="serviceStatsChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- æœåŠ¡æ³¨å†Œï¼ˆé»˜è®¤æ”¶èµ·ï¼‰ -->
      <div class="bg-white rounded-2xl shadow p-6 border border-gray-100 mb-8">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-r from-finance-green to-green-500 text-white flex items-center justify-center text-sm font-bold">SR</div>
            <h2 class="text-xl font-semibold text-slate-800">æœåŠ¡æ³¨å†Œ</h2>
          </div>
          <button id="toggleForm" class="px-3 py-1.5 rounded bg-blue-600 text-white text-sm hover:bg-blue-700 transition-colors">
            <span id="toggleText">å±•å¼€</span>
          </button>
        </div>
        <div id="serviceForm" class="hidden mt-6">
          <form id="svcForm" class="space-y-6">
            <!-- ç¬¬ä¸€è¡Œï¼šæœåŠ¡åç§° + æ–¹æ³• -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium mb-1">æœåŠ¡åç§°</label>
                <input id="svcName" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="product-purchase" value="product-purchase" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">HTTP æ–¹æ³•</label>
                <select id="svcMethod" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="GET">GET</option>
                  <option value="POST" selected>POST</option>
                </select>
              </div>
            </div>
            <!-- ç¬¬äºŒè¡Œï¼šæœåŠ¡åœ°å€ + æœåŠ¡è·¯å¾„ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium mb-1">æœåŠ¡åœ°å€</label>
                <input id="svcUrl" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="http://127.0.0.1:9001" value="http://127.0.0.1:9001" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">æœåŠ¡è·¯å¾„</label>
                <input id="svcServicePath" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="/purchase" value="/purchase" />
              </div>
            </div>
            <!-- æ–°å¢ï¼šè¯·æ±‚å¤´ï¼ˆJSONï¼‰ -->
            <div>
              <label class="block text-sm font-medium mb-1">è¯·æ±‚å¤´ï¼ˆJSONï¼‰</label>
              <textarea id="svcHeaders" class="w-full border rounded px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder='{"Content-Type":"application/json"}'>{"Content-Type":"application/json"}</textarea>
            </div>
            <!-- ç¬¬ä¸‰è¡Œï¼šè¯·æ±‚/å“åº”å‚æ•° -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                              <div>
                  <label class="block text-sm font-medium mb-1">è¯·æ±‚å‚æ•°ï¼ˆJSONï¼‰</label>
                  <textarea id="svcRequestParams" class="w-full border rounded px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder='{
  "product_id": "FUND001",
  "user_id": "CURRENT_USER",
  "amount": 10000,
  "payment_method": "bank_transfer",
  "risk_agreement": true
}'>{
  "product_id": "FUND001",
  "user_id": "CURRENT_USER",
  "amount": 10000,
  "payment_method": "bank_transfer",
  "risk_agreement": true
}</textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">å“åº”å‚æ•°ï¼ˆJSONï¼‰</label>
                  <textarea id="svcResponseParams" class="w-full border rounded px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder='{
  "service_name": "product-purchase",
  "order_id": "ORDER_XXXX",
  "product_id": "FUND001",
  "amount": 10000,
  "status": "processing",
  "message": "è®¢å•å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†ä¸­"
}'>{
  "service_name": "product-purchase",
  "order_id": "ORDER_XXXX",
  "product_id": "FUND001",
  "amount": 10000,
  "status": "processing",
  "message": "è®¢å•å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†ä¸­"
}</textarea>
                </div>
            </div>
            <!-- ç¬¬å››è¡Œï¼šæè¿° -->
                          <div>
                <label class="block text-sm font-medium mb-1">æœåŠ¡æè¿°</label>
                <textarea id="svcSummary" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="ç†è´¢äº§å“è´­ä¹°æœåŠ¡ï¼Œæ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼å’Œé£é™©åè®®ç¡®è®¤">ç†è´¢äº§å“è´­ä¹°æœåŠ¡ï¼Œæ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼å’Œé£é™©åè®®ç¡®è®¤</textarea>
              </div>
            <div class="flex items-center gap-3 pt-2">
              <button type="submit" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700 transition-colors">æ·»åŠ æœåŠ¡</button>
              <button type="button" id="clearBtn" class="px-4 py-2 rounded bg-gray-600 text-white hover:bg-gray-700 transition-colors">æ¸…ç©º</button>
              <span id="svcMsg" class="text-sm text-green-700"></span>
            </div>
          </form>
        </div>
      </div>

      <!-- æœåŠ¡åˆ—è¡¨ -->
      <div class="bg-white rounded-2xl shadow p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-r from-finance-blue to-blue-600 text-white flex items-center justify-center text-sm font-bold">SL</div>
            <h2 class="text-xl font-semibold text-slate-800">æœåŠ¡åˆ—è¡¨</h2>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-slate-600">æ¯é¡µ</label>
            <select id="pageSize" class="border rounded px-2 py-1 text-sm">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
            <button id="refreshBtn" class="px-3 py-1.5 rounded bg-blue-600 text-white text-sm hover:bg-blue-700 transition-colors">åˆ·æ–°</button>
            <button id="mcpHelpBtn" class="px-3 py-1.5 rounded border text-sm hover:bg-gray-50 transition-colors">é…ç½® MCP è¯´æ˜</button>
          </div>
        </div>
        <div class="flex items-center justify-end gap-2 mb-2 text-sm">
          <button id="prevPage" class="px-2 py-1 rounded border hover:bg-gray-50 transition-colors">ä¸Šä¸€é¡µ</button>
          <span id="pageInfo" class="text-slate-600">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
          <button id="nextPage" class="px-2 py-1 rounded border hover:bg-gray-50 transition-colors">ä¸‹ä¸€é¡µ</button>
        </div>
        <div class="relative">
          <div class="overflow-x-auto">
            <table class="w-full min-w-[1800px] text-sm">
              <thead>
                <tr class="text-left border-b bg-gray-50">
                  <th class="px-3 py-2 min-w-[120px]">åç§°</th>
                  <th class="px-3 py-2 min-w-[180px]">åœ°å€</th>
                  <th class="px-3 py-2 min-w-[120px]">è·¯å¾„</th>
                  <th class="px-3 py-2 min-w-[80px]">æ–¹æ³•</th>
                  <th class="px-3 py-2 min-w-[250px]">è¯·æ±‚å‚æ•°</th>
                  <th class="px-3 py-2 min-w-[250px]">å“åº”å‚æ•°</th>
                  <th class="px-3 py-2 min-w-[200px]">è¯·æ±‚å¤´</th>
                  <th class="px-3 py-2 min-w-[200px]">æè¿°</th>
                  <th class="px-3 py-2 min-w-[120px] sticky right-0 bg-white">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="svcTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª—ï¼ˆä¸é¡µé¢é£æ ¼ä¸€è‡´ï¼‰ -->
    <div id="confirmModal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-gray-100">
          <div class="px-6 py-4 border-b">
            <h3 class="text-lg font-semibold text-slate-800">ç¡®è®¤åˆ é™¤</h3>
          </div>
          <div class="px-6 py-4 text-slate-700">
            ç¡®å®šè¦åˆ é™¤æœåŠ¡ <span id="confirmServiceName" class="font-semibold text-slate-900"></span> å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚
          </div>
          <div class="px-6 py-4 border-t flex justify-end gap-3">
            <button id="cancelDeleteBtn" class="px-3 py-1.5 rounded border hover:bg-gray-50">å–æ¶ˆ</button>
            <button id="confirmDeleteBtn" class="px-3 py-1.5 rounded bg-red-600 text-white hover:bg-red-700">åˆ é™¤</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MCP é…ç½®è¯´æ˜å¼¹çª— -->
    <div id="mcpHelpModal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl border border-gray-100">
          <div class="px-6 py-4 border-b flex items-center justify-between">
            <h3 class="text-lg font-semibold text-slate-800">MCP é…ç½®</h3>
            <button id="mcpHelpCloseBtn" class="px-2 py-1 rounded hover:bg-gray-100">âœ•</button>
          </div>
          <div class="px-6 py-4 text-slate-700 space-y-4">
            <p class="text-sm">åœ¨å®¢æˆ·ç«¯çš„ <span class="font-mono">mcp.json</span> ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼ŒæŒ‡å‘æœ¬æœåŠ¡çš„ <span class="font-mono">/mcp</span> è·¯å¾„ï¼š</p>
            <div class="bg-gray-50 border rounded p-3 overflow-auto">
              <pre class="text-xs leading-relaxed"><code>{
  "mcpServers": {
    "api-proxy-mcp": {
      "url": "http://127.0.0.1:8000/mcp"
    }
  }
}</code></pre>
            </div>
            <ul class="list-disc pl-5 mt-1 text-sm text-slate-700 space-y-1">
              <li>ç¡®ä¿æœ¬æœåŠ¡å·²å¯åŠ¨ï¼šè®¿é—® <span class="font-mono">/health</span> è¿”å› <span class="font-mono">{"status":"ok"}</span>ã€‚</li>
              <li>æ ¹æ®å®é™…éƒ¨ç½²ä¿®æ”¹ç«¯å£æˆ–åŸŸåã€‚</li>
              <li>ä¿å­˜åé‡å¯ä½ çš„ MCP å®¢æˆ·ç«¯/ç¼–è¾‘å™¨ã€‚</li>
            </ul>
          </div>
          <div class="px-6 py-4 border-t flex justify-end gap-3">
          </div>
        </div>
      </div>
    </div>

    <script>
      // çŠ¶æ€
      let allServices = [];
      let currentPage = 1;
      let pageSize = 10;
      let serviceStatsChart = null;

      // å·¥å…·
      function showMsg(el, text) { el.textContent = text; setTimeout(()=> el.textContent='', 1500); }
      function parseJSONSafe(str, fallback) { try { return JSON.parse(str || ''); } catch { return fallback; } }

      // ç›‘æ§ç›¸å…³å‡½æ•°
      async function loadMonitoringData() {
        try {
          // åŠ è½½æœåŠ¡çŠ¶æ€
          const statusRes = await fetch('/api/monitoring/status');
          const statusData = await statusRes.json();
          updateServiceStatus(statusData);

          // åŠ è½½æœåŠ¡ç»Ÿè®¡
          const statsRes = await fetch('/api/monitoring/stats');
          const statsData = await statsRes.json();
          updateServiceStats(statsData);
        } catch (error) {
          console.error('åŠ è½½ç›‘æ§æ•°æ®å¤±è´¥:', error);
        }
      }

      function updateServiceStatus(statusData) {
        // æ›´æ–°MCPæœåŠ¡çŠ¶æ€
        const mcpStatusEl = document.getElementById('mcpServiceStatus');
        const mcpStatus = statusData.mcp_main_service?.status || 'unknown';
        const mcpIndicator = mcpStatusEl.querySelector('.w-3');
        const mcpText = mcpStatusEl.querySelector('span');
        
        if (mcpStatus === 'running') {
          mcpIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
          mcpText.textContent = 'è¿è¡Œä¸­';
          mcpText.className = 'text-sm text-green-600';
        } else if (mcpStatus === 'stopped') {
          mcpIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
          mcpText.textContent = 'å·²åœæ­¢';
          mcpText.className = 'text-sm text-red-600';
        } else {
          mcpIndicator.className = 'w-3 h-3 rounded-full bg-gray-400';
          mcpText.textContent = 'æœªçŸ¥';
          mcpText.className = 'text-sm text-gray-600';
        }
      }

      function updateServiceStats(statsData) {
        // æ›´æ–°æ€»è°ƒç”¨æ¬¡æ•°
        document.getElementById('totalCalls').textContent = statsData.total_calls || 0;
        
        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        const now = new Date();
        document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();

        // æ›´æ–°å›¾è¡¨
        updateChart(statsData.services || []);
      }

      function updateChart(services) {
        const ctx = document.getElementById('serviceStatsChart').getContext('2d');
        
        // é”€æ¯ç°æœ‰å›¾è¡¨
        if (serviceStatsChart) {
          serviceStatsChart.destroy();
        }

        const labels = services.map(s => s.name);
        const data = services.map(s => s.call_count);
        
        // æ‰©å±•é¢œè‰²æ•°ç»„ä»¥æ”¯æŒæ›´å¤šæœåŠ¡
        const colors = [
          'rgba(59, 130, 246, 0.8)',   // blue
          'rgba(16, 185, 129, 0.8)',   // green
          'rgba(245, 158, 11, 0.8)',   // yellow
          'rgba(239, 68, 68, 0.8)',    // red
          'rgba(139, 92, 246, 0.8)',   // purple
          'rgba(236, 72, 153, 0.8)',   // pink
          'rgba(34, 197, 94, 0.8)',    // emerald
          'rgba(249, 115, 22, 0.8)',   // orange
          'rgba(168, 85, 247, 0.8)',   // violet
          'rgba(14, 165, 233, 0.8)',   // sky
          'rgba(20, 184, 166, 0.8)',   // teal
          'rgba(244, 63, 94, 0.8)',    // rose
        ];

        // ä¸ºæ¯ä¸ªæœåŠ¡åˆ†é…é¢œè‰²ï¼Œå¦‚æœæœåŠ¡æ•°é‡è¶…è¿‡é¢œè‰²æ•°ç»„é•¿åº¦ï¼Œå¾ªç¯ä½¿ç”¨
        const serviceColors = labels.map((_, index) => colors[index % colors.length]);

        serviceStatsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'è°ƒç”¨æ¬¡æ•°',
              data: data,
              backgroundColor: serviceColors,
              borderColor: serviceColors.map(c => c.replace('0.8', '1')),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 0
                }
              },
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      }

      // åŠ è½½/æ¸²æŸ“
      async function loadServices() {
        const res = await fetch('/api/services');
        allServices = await res.json();
        currentPage = Math.min(currentPage, Math.max(1, Math.ceil(allServices.length / pageSize) || 1));
        renderServices();
        updatePagination();
      }

      function renderServices() {
        const tbody = document.getElementById('svcTbody');
        tbody.innerHTML = '';
        const start = (currentPage - 1) * pageSize;
        const pageItems = allServices.slice(start, start + pageSize);
        pageItems.forEach(s => {
          const tr = document.createElement('tr');
          tr.className = 'border-b last:border-b-0 hover:bg-gray-50 transition-colors';
          const headersJson = JSON.stringify(s.headers || {}, null, 2);
          tr.innerHTML = `
            <td class="px-3 py-2"><input class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${s.name}" data-id="${s.id}" data-field="name"></td>
            <td class="px-3 py-2"><input class="w-full border rounded px-2 py-1 font-mono text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${s.url}" data-id="${s.id}" data-field="url"></td>
            <td class="px-3 py-2"><input class="w-full border rounded px-2 py-1 font-mono text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${s.service_path || ''}" data-id="${s.id}" data-field="service_path"></td>
            <td class="px-3 py-2">
              <select class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-id="${s.id}" data-field="method">
                <option value="GET" ${s.method==='GET'?'selected':''}>GET</option>
                <option value="POST" ${s.method==='POST'?'selected':''}>POST</option>
              </select>
            </td>
            <td class="px-3 py-2"><textarea class="w-full border rounded px-2 py-1 font-mono text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" data-id="${s.id}" data-field="request_params">${JSON.stringify(s.request_params||{}, null, 2)}</textarea></td>
            <td class="px-3 py-2"><textarea class="w-full border rounded px-2 py-1 font-mono text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" data-id="${s.id}" data-field="response_params">${JSON.stringify(s.response_params||{}, null, 2)}</textarea></td>
            <td class="px-3 py-2"><textarea class="w-full border rounded px-2 py-1 font-mono text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" data-id="${s.id}" data-field="headers">${headersJson}</textarea></td>
            <td class="px-3 py-2"><textarea class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" data-id="${s.id}" data-field="summary">${s.summary || ''}</textarea></td>
            <td class="px-3 py-2 sticky right-0 bg-white">
              <div class="flex items-center gap-2">
                <button class="px-2 py-1 rounded bg-green-600 text-white text-xs hover:bg-green-700 transition-colors" data-act="save" data-id="${s.id}">ä¿å­˜</button>
                <button class="px-2 py-1 rounded bg-red-600 text-white text-xs hover:bg-red-700 transition-colors" data-act="delete" data-id="${s.id}">åˆ é™¤</button>
              </div>
            </td>`;
          tbody.appendChild(tr);
        });
        bindRowActions();
      }

      function updatePagination() {
        const totalPages = Math.max(1, Math.ceil(allServices.length / pageSize));
        document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ`;
        document.getElementById('prevPage').disabled = currentPage <= 1;
        document.getElementById('nextPage').disabled = currentPage >= totalPages;
      }

      // è‡ªå®šä¹‰åˆ é™¤ç¡®è®¤å¼¹çª—
      function showConfirmModal(serviceName) {
        return new Promise((resolve) => {
          const modal = document.getElementById('confirmModal');
          const nameEl = document.getElementById('confirmServiceName');
          const confirmBtn = document.getElementById('confirmDeleteBtn');
          const cancelBtn = document.getElementById('cancelDeleteBtn');
          const backdrop = modal.querySelector('.absolute.inset-0');

          nameEl.textContent = serviceName || '';
          modal.classList.remove('hidden');

          const cleanup = () => {
            modal.classList.add('hidden');
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
            backdrop.onclick = null;
            document.onkeydown = null;
          };

          confirmBtn.onclick = () => { cleanup(); resolve(true); };
          cancelBtn.onclick = () => { cleanup(); resolve(false); };
          backdrop.onclick = () => { cleanup(); resolve(false); };
          document.onkeydown = (e) => { if (e.key === 'Escape') { cleanup(); resolve(false); } };
        });
      }

      function bindRowActions() {
        const tbody = document.getElementById('svcTbody');
        tbody.querySelectorAll('button').forEach(btn => {
          btn.onclick = async (e) => {
            e.preventDefault();
            const id = btn.getAttribute('data-id');
            const act = btn.getAttribute('data-act');
            if (act === 'delete') {
              const nameEl = tbody.querySelector(`input[data-id="${id}"][data-field="name"]`);
              const svcName = nameEl ? nameEl.value : 'è¯¥æœåŠ¡';
              const ok = await showConfirmModal(svcName);
              if (ok) {
                await fetch(`/api/services/${id}`, { method: 'DELETE' });
                await loadServices();
              }
              return;
            }
            if (act === 'save') {
              const inputs = Array.from(tbody.querySelectorAll(`input[data-id="${id}"]`));
              const textareas = Array.from(tbody.querySelectorAll(`textarea[data-id="${id}"]`));
              const selects = Array.from(tbody.querySelectorAll(`select[data-id="${id}"]`));
              const payload = {};
              inputs.forEach(inp => {
                const f = inp.getAttribute('data-field');
                payload[f] = inp.value;
              });
              textareas.forEach(ta => {
                const f = ta.getAttribute('data-field');
                payload[f] = (f === 'request_params' || f === 'response_params' || f === 'headers') ? parseJSONSafe(ta.value, {}) : ta.value;
              });
              selects.forEach(sel => {
                const f = sel.getAttribute('data-field');
                payload[f] = sel.value;
              });
              await fetch(`/api/services/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
              await loadServices();
            }
          };
        });
      }

      // æ·»åŠ æœåŠ¡
      async function addService(evt) {
        evt.preventDefault();
        const payload = {
          name: document.getElementById('svcName').value,
          summary: document.getElementById('svcSummary').value,
          url: document.getElementById('svcUrl').value,
          service_path: document.getElementById('svcServicePath').value,
          method: document.getElementById('svcMethod').value,
          request_params: parseJSONSafe(document.getElementById('svcRequestParams').value, {}),
          response_params: parseJSONSafe(document.getElementById('svcResponseParams').value, {}),
          headers: parseJSONSafe(document.getElementById('svcHeaders').value, {})
        };
        const res = await fetch('/api/services', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (res.ok) {
          showMsg(document.getElementById('svcMsg'), 'å·²æ·»åŠ ');
          document.getElementById('svcForm').reset();
          await loadServices();
        }
      }

      // äº‹ä»¶ç»‘å®š
      document.getElementById('svcForm').addEventListener('submit', addService);
      document.getElementById('clearBtn').addEventListener('click', () => {
        // çœŸæ­£çš„æ¸…ç©ºæ‰€æœ‰å­—æ®µ
        document.getElementById('svcName').value = '';
        document.getElementById('svcSummary').value = '';
        document.getElementById('svcUrl').value = '';
        document.getElementById('svcServicePath').value = '';
        document.getElementById('svcMethod').value = 'GET';
        document.getElementById('svcHeaders').value = '';
        document.getElementById('svcRequestParams').value = '';
        document.getElementById('svcResponseParams').value = '';
        showMsg(document.getElementById('svcMsg'), 'å·²æ¸…ç©º');
      });

      document.getElementById('refreshBtn').addEventListener('click', loadServices);
      document.getElementById('pageSize').addEventListener('change', () => { pageSize = parseInt(document.getElementById('pageSize').value||'10'); currentPage = 1; renderServices(); updatePagination(); });
      document.getElementById('prevPage').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderServices(); updatePagination(); } });
      document.getElementById('nextPage').addEventListener('click', () => { const totalPages = Math.max(1, Math.ceil(allServices.length / pageSize)); if (currentPage < totalPages) { currentPage++; renderServices(); updatePagination(); } });
      document.getElementById('toggleForm').addEventListener('click', () => {
        const form = document.getElementById('serviceForm');
        const t = document.getElementById('toggleText');
        const isHidden = form.classList.contains('hidden');
        if (isHidden) { form.classList.remove('hidden'); t.textContent = 'æ”¶èµ·'; }
        else { form.classList.add('hidden'); t.textContent = 'å±•å¼€'; }
      });

      // ç›‘æ§ç›¸å…³äº‹ä»¶ç»‘å®š
      document.getElementById('toggleMonitoring').addEventListener('click', () => {
        const content = document.getElementById('monitoringContent');
        const t = document.getElementById('toggleMonitoringText');
        const refreshBtn = document.getElementById('refreshMonitoring');
        const isHidden = content.classList.contains('hidden');
        if (isHidden) { 
          content.classList.remove('hidden'); 
          t.textContent = 'æ”¶èµ·';
          refreshBtn.classList.remove('hidden'); // æ˜¾ç¤ºåˆ·æ–°æŒ‰é’®
          // å±•å¼€æ—¶åŠ è½½ç›‘æ§æ•°æ®
          loadMonitoringData();
        } else { 
          content.classList.add('hidden'); 
          t.textContent = 'å±•å¼€';
          refreshBtn.classList.add('hidden'); // éšè—åˆ·æ–°æŒ‰é’®
        }
      });

      document.getElementById('refreshMonitoring').addEventListener('click', () => {
        loadMonitoringData();
      });

      // MCP è¯´æ˜å¼¹çª—é€»è¾‘
      (function(){
        const modal = document.getElementById('mcpHelpModal');
        const backdrop = modal.querySelector('.absolute.inset-0');
        const openBtn = document.getElementById('mcpHelpBtn');
        const closeBtn = document.getElementById('mcpHelpCloseBtn');
        const okBtn = document.getElementById('mcpHelpOkBtn');
        function open(){ modal.classList.remove('hidden'); }
        function close(){ modal.classList.add('hidden'); }
        openBtn?.addEventListener('click', open);
        closeBtn?.addEventListener('click', close);
        okBtn?.addEventListener('click', close);
        backdrop?.addEventListener('click', close);
        document.addEventListener('keydown', (e) => { if (!modal.classList.contains('hidden') && e.key === 'Escape') close(); });
      })();

      // åˆå§‹åŒ–
      window.onload = loadServices;
    </script>
  </body>
</html>
