<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>金融服务MCP管理平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { theme: { extend: { colors: { 'finance-blue': '#1e40af', 'finance-green': '#059669', 'finance-gold': '#d97706' } } } };
    </script>
  </head>
  <body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-slate-800">金融服务MCP管理平台</h1>
      </div>

      <!-- 服务注册（默认收起） -->
      <div class="bg-white rounded-2xl shadow p-6 border border-gray-100 mb-8">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-r from-finance-green to-green-500 text-white flex items-center justify-center text-sm font-bold">SR</div>
            <h2 class="text-xl font-semibold text-slate-800">服务注册</h2>
          </div>
          <button id="toggleForm" class="px-3 py-1.5 rounded bg-blue-600 text-white text-sm hover:bg-blue-700 transition-colors">
            <span id="toggleText">展开</span>
          </button>
        </div>
        <div id="serviceForm" class="hidden mt-6">
          <form id="svcForm" class="space-y-6">
            <!-- 第一行：服务名称 + 方法 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium mb-1">服务名称</label>
                <input id="svcName" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="product-purchase" value="product-purchase" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">HTTP 方法</label>
                <select id="svcMethod" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <option value="GET">GET</option>
                  <option value="POST" selected>POST</option>
                </select>
              </div>
            </div>
            <!-- 第二行：服务地址 + 服务路径 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium mb-1">服务地址</label>
                <input id="svcUrl" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="http://127.0.0.1:9001" value="http://127.0.0.1:9001" />
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">服务路径</label>
                <input id="svcServicePath" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="/purchase" value="/purchase" />
              </div>
            </div>
            <!-- 新增：请求头（JSON） -->
            <div>
              <label class="block text-sm font-medium mb-1">请求头（JSON）</label>
              <textarea id="svcHeaders" class="w-full border rounded px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder='{"Content-Type":"application/json"}'>{"Content-Type":"application/json"}</textarea>
            </div>
            <!-- 第三行：请求/响应参数 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                              <div>
                  <label class="block text-sm font-medium mb-1">请求参数（JSON）</label>
                  <textarea id="svcRequestParams" class="w-full border rounded px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder='{
  "product_id": "FUND001",
  "user_id": "CURRENT_USER",
  "amount": 10000,
  "payment_method": "bank_transfer",
  "risk_agreement": true
}'>{
  "product_id": "FUND001",
  "user_id": "CURRENT_USER",
  "amount": 10000,
  "payment_method": "bank_transfer",
  "risk_agreement": true
}</textarea>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">响应参数（JSON）</label>
                  <textarea id="svcResponseParams" class="w-full border rounded px-3 py-2 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder='{
  "service_name": "product-purchase",
  "order_id": "ORDER_XXXX",
  "product_id": "FUND001",
  "amount": 10000,
  "status": "processing",
  "message": "订单已提交，正在处理中"
}'>{
  "service_name": "product-purchase",
  "order_id": "ORDER_XXXX",
  "product_id": "FUND001",
  "amount": 10000,
  "status": "processing",
  "message": "订单已提交，正在处理中"
}</textarea>
                </div>
            </div>
            <!-- 第四行：描述 -->
                          <div>
                <label class="block text-sm font-medium mb-1">服务描述</label>
                <textarea id="svcSummary" class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="理财产品购买服务，支持多种支付方式和风险协议确认">理财产品购买服务，支持多种支付方式和风险协议确认</textarea>
              </div>
            <div class="flex items-center gap-3 pt-2">
              <button type="submit" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700 transition-colors">添加服务</button>
              <button type="button" id="clearBtn" class="px-4 py-2 rounded bg-gray-600 text-white hover:bg-gray-700 transition-colors">清空</button>
              <span id="svcMsg" class="text-sm text-green-700"></span>
            </div>
          </form>
        </div>
      </div>

      <!-- 服务列表 -->
      <div class="bg-white rounded-2xl shadow p-6 border border-gray-100">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-r from-finance-blue to-blue-600 text-white flex items-center justify-center text-sm font-bold">SL</div>
            <h2 class="text-xl font-semibold text-slate-800">服务列表</h2>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-slate-600">每页</label>
            <select id="pageSize" class="border rounded px-2 py-1 text-sm">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="20">20</option>
              <option value="50">50</option>
            </select>
            <button id="refreshBtn" class="px-3 py-1.5 rounded bg-blue-600 text-white text-sm hover:bg-blue-700 transition-colors">刷新</button>
          </div>
        </div>
        <div class="flex items-center justify-end gap-2 mb-2 text-sm">
          <button id="prevPage" class="px-2 py-1 rounded border hover:bg-gray-50 transition-colors">上一页</button>
          <span id="pageInfo" class="text-slate-600">第 1 页，共 1 页</span>
          <button id="nextPage" class="px-2 py-1 rounded border hover:bg-gray-50 transition-colors">下一页</button>
        </div>
        <div class="relative">
          <div class="overflow-x-auto">
            <table class="w-full min-w-[1800px] text-sm">
              <thead>
                <tr class="text-left border-b bg-gray-50">
                  <th class="px-3 py-2 min-w-[120px]">名称</th>
                  <th class="px-3 py-2 min-w-[180px]">地址</th>
                  <th class="px-3 py-2 min-w-[120px]">路径</th>
                  <th class="px-3 py-2 min-w-[80px]">方法</th>
                  <th class="px-3 py-2 min-w-[250px]">请求参数</th>
                  <th class="px-3 py-2 min-w-[250px]">响应参数</th>
                  <th class="px-3 py-2 min-w-[200px]">请求头</th>
                  <th class="px-3 py-2 min-w-[200px]">描述</th>
                  <th class="px-3 py-2 min-w-[120px] sticky right-0 bg-white">操作</th>
                </tr>
              </thead>
              <tbody id="svcTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- 删除确认弹窗（与页面风格一致） -->
    <div id="confirmModal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-gray-100">
          <div class="px-6 py-4 border-b">
            <h3 class="text-lg font-semibold text-slate-800">确认删除</h3>
          </div>
          <div class="px-6 py-4 text-slate-700">
            确定要删除服务 <span id="confirmServiceName" class="font-semibold text-slate-900"></span> 吗？此操作不可恢复。
          </div>
          <div class="px-6 py-4 border-t flex justify-end gap-3">
            <button id="cancelDeleteBtn" class="px-3 py-1.5 rounded border hover:bg-gray-50">取消</button>
            <button id="confirmDeleteBtn" class="px-3 py-1.5 rounded bg-red-600 text-white hover:bg-red-700">删除</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 状态
      let allServices = [];
      let currentPage = 1;
      let pageSize = 10;

      // 工具
      function showMsg(el, text) { el.textContent = text; setTimeout(()=> el.textContent='', 1500); }
      function parseJSONSafe(str, fallback) { try { return JSON.parse(str || ''); } catch { return fallback; } }

      // 加载/渲染
      async function loadServices() {
        const res = await fetch('/api/services');
        allServices = await res.json();
        currentPage = Math.min(currentPage, Math.max(1, Math.ceil(allServices.length / pageSize) || 1));
        renderServices();
        updatePagination();
      }

      function renderServices() {
        const tbody = document.getElementById('svcTbody');
        tbody.innerHTML = '';
        const start = (currentPage - 1) * pageSize;
        const pageItems = allServices.slice(start, start + pageSize);
        pageItems.forEach(s => {
          const tr = document.createElement('tr');
          tr.className = 'border-b last:border-b-0 hover:bg-gray-50 transition-colors';
          const headersJson = JSON.stringify(s.headers || {}, null, 2);
          tr.innerHTML = `
            <td class="px-3 py-2"><input class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${s.name}" data-id="${s.id}" data-field="name"></td>
            <td class="px-3 py-2"><input class="w-full border rounded px-2 py-1 font-mono text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${s.url}" data-id="${s.id}" data-field="url"></td>
            <td class="px-3 py-2"><input class="w-full border rounded px-2 py-1 font-mono text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${s.service_path || ''}" data-id="${s.id}" data-field="service_path"></td>
            <td class="px-3 py-2">
              <select class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-id="${s.id}" data-field="method">
                <option value="GET" ${s.method==='GET'?'selected':''}>GET</option>
                <option value="POST" ${s.method==='POST'?'selected':''}>POST</option>
              </select>
            </td>
            <td class="px-3 py-2"><textarea class="w-full border rounded px-2 py-1 font-mono text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" data-id="${s.id}" data-field="request_params">${JSON.stringify(s.request_params||{}, null, 2)}</textarea></td>
            <td class="px-3 py-2"><textarea class="w-full border rounded px-2 py-1 font-mono text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" data-id="${s.id}" data-field="response_params">${JSON.stringify(s.response_params||{}, null, 2)}</textarea></td>
            <td class="px-3 py-2"><textarea class="w-full border rounded px-2 py-1 font-mono text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" data-id="${s.id}" data-field="headers">${headersJson}</textarea></td>
            <td class="px-3 py-2"><textarea class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" data-id="${s.id}" data-field="summary">${s.summary || ''}</textarea></td>
            <td class="px-3 py-2 sticky right-0 bg-white">
              <div class="flex items-center gap-2">
                <button class="px-2 py-1 rounded bg-green-600 text-white text-xs hover:bg-green-700 transition-colors" data-act="save" data-id="${s.id}">保存</button>
                <button class="px-2 py-1 rounded bg-red-600 text-white text-xs hover:bg-red-700 transition-colors" data-act="delete" data-id="${s.id}">删除</button>
              </div>
            </td>`;
          tbody.appendChild(tr);
        });
        bindRowActions();
      }

      function updatePagination() {
        const totalPages = Math.max(1, Math.ceil(allServices.length / pageSize));
        document.getElementById('pageInfo').textContent = `第 ${currentPage} 页，共 ${totalPages} 页`;
        document.getElementById('prevPage').disabled = currentPage <= 1;
        document.getElementById('nextPage').disabled = currentPage >= totalPages;
      }

      // 自定义删除确认弹窗
      function showConfirmModal(serviceName) {
        return new Promise((resolve) => {
          const modal = document.getElementById('confirmModal');
          const nameEl = document.getElementById('confirmServiceName');
          const confirmBtn = document.getElementById('confirmDeleteBtn');
          const cancelBtn = document.getElementById('cancelDeleteBtn');
          const backdrop = modal.querySelector('.absolute.inset-0');

          nameEl.textContent = serviceName || '';
          modal.classList.remove('hidden');

          const cleanup = () => {
            modal.classList.add('hidden');
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
            backdrop.onclick = null;
            document.onkeydown = null;
          };

          confirmBtn.onclick = () => { cleanup(); resolve(true); };
          cancelBtn.onclick = () => { cleanup(); resolve(false); };
          backdrop.onclick = () => { cleanup(); resolve(false); };
          document.onkeydown = (e) => { if (e.key === 'Escape') { cleanup(); resolve(false); } };
        });
      }

      function bindRowActions() {
        const tbody = document.getElementById('svcTbody');
        tbody.querySelectorAll('button').forEach(btn => {
          btn.onclick = async (e) => {
            e.preventDefault();
            const id = btn.getAttribute('data-id');
            const act = btn.getAttribute('data-act');
            if (act === 'delete') {
              const nameEl = tbody.querySelector(`input[data-id="${id}"][data-field="name"]`);
              const svcName = nameEl ? nameEl.value : '该服务';
              const ok = await showConfirmModal(svcName);
              if (ok) {
                await fetch(`/api/services/${id}`, { method: 'DELETE' });
                await loadServices();
              }
              return;
            }
            if (act === 'save') {
              const inputs = Array.from(tbody.querySelectorAll(`input[data-id="${id}"]`));
              const textareas = Array.from(tbody.querySelectorAll(`textarea[data-id="${id}"]`));
              const selects = Array.from(tbody.querySelectorAll(`select[data-id="${id}"]`));
              const payload = {};
              inputs.forEach(inp => {
                const f = inp.getAttribute('data-field');
                payload[f] = inp.value;
              });
              textareas.forEach(ta => {
                const f = ta.getAttribute('data-field');
                payload[f] = (f === 'request_params' || f === 'response_params' || f === 'headers') ? parseJSONSafe(ta.value, {}) : ta.value;
              });
              selects.forEach(sel => {
                const f = sel.getAttribute('data-field');
                payload[f] = sel.value;
              });
              await fetch(`/api/services/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
              await loadServices();
            }
          };
        });
      }

      // 添加服务
      async function addService(evt) {
        evt.preventDefault();
        const payload = {
          name: document.getElementById('svcName').value,
          summary: document.getElementById('svcSummary').value,
          url: document.getElementById('svcUrl').value,
          service_path: document.getElementById('svcServicePath').value,
          method: document.getElementById('svcMethod').value,
          request_params: parseJSONSafe(document.getElementById('svcRequestParams').value, {}),
          response_params: parseJSONSafe(document.getElementById('svcResponseParams').value, {}),
          headers: parseJSONSafe(document.getElementById('svcHeaders').value, {})
        };
        const res = await fetch('/api/services', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (res.ok) {
          showMsg(document.getElementById('svcMsg'), '已添加');
          document.getElementById('svcForm').reset();
          await loadServices();
        }
      }

      // 事件绑定
      document.getElementById('svcForm').addEventListener('submit', addService);
      document.getElementById('clearBtn').addEventListener('click', () => {
        // 真正的清空所有字段
        document.getElementById('svcName').value = '';
        document.getElementById('svcSummary').value = '';
        document.getElementById('svcUrl').value = '';
        document.getElementById('svcServicePath').value = '';
        document.getElementById('svcMethod').value = 'GET';
        document.getElementById('svcHeaders').value = '';
        document.getElementById('svcRequestParams').value = '';
        document.getElementById('svcResponseParams').value = '';
        showMsg(document.getElementById('svcMsg'), '已清空');
      });

      document.getElementById('refreshBtn').addEventListener('click', loadServices);
      document.getElementById('pageSize').addEventListener('change', () => { pageSize = parseInt(document.getElementById('pageSize').value||'10'); currentPage = 1; renderServices(); updatePagination(); });
      document.getElementById('prevPage').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderServices(); updatePagination(); } });
      document.getElementById('nextPage').addEventListener('click', () => { const totalPages = Math.max(1, Math.ceil(allServices.length / pageSize)); if (currentPage < totalPages) { currentPage++; renderServices(); updatePagination(); } });
      document.getElementById('toggleForm').addEventListener('click', () => {
        const form = document.getElementById('serviceForm');
        const t = document.getElementById('toggleText');
        const isHidden = form.classList.contains('hidden');
        if (isHidden) { form.classList.remove('hidden'); t.textContent = '收起'; }
        else { form.classList.add('hidden'); t.textContent = '展开'; }
      });

      // 初始化
      window.onload = loadServices;
    </script>
  </body>
</html>
