# MCP JSON æ ¼å¼é—®é¢˜åˆ†æ

## ğŸš¨ é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆçš„é”™è¯¯ä¿¡æ¯ï¼š
```
"Input validation error: {'product_id': 'FUND001', 'amount': 1000, 'payment_method': 'online_banking', 'risk_agreement': True} is not of type 'string'"
```

### é—®é¢˜ç°è±¡
- MCPå®¢æˆ·ç«¯ä¼ é€’çš„æ˜¯**Pythonå­—å…¸å¯¹è±¡**
- ç¨‹åºæœŸæœ›çš„æ˜¯**å­—ç¬¦ä¸²æ ¼å¼çš„JSON**
- å¯¼è‡´ç±»å‹éªŒè¯å¤±è´¥

## ğŸ” é—®é¢˜åˆ†æ

### 1. å‚æ•°ä¼ é€’æ–¹å¼å¯¹æ¯”

**MCPå®¢æˆ·ç«¯å®é™…ä¼ é€’æ–¹å¼**ï¼š
```json
{
  "params": {
    "service_id": 3,
    "method": "POST",
    "path": "/purchase",
    "json": {
      "product_id": "FUND001",
      "amount": 1000,
      "payment_method": "online_banking",
      "risk_agreement": true
    }
  }
}
```

**æˆ‘ä»¬ç¨‹åºä¹‹å‰æœŸæœ›çš„æ–¹å¼**ï¼š
```json
{
  "params": {
    "service_id": 3,
    "method": "POST", 
    "path": "/purchase",
    "json": "{\"product_id\": \"FUND001\", \"amount\": 1000, \"payment_method\": \"online_banking\", \"risk_agreement\": true}"
  }
}
```

### 2. é”™è¯¯æ¥æºåˆ†æ

ç»è¿‡æ—¥å¿—åˆ†æï¼Œè¿™ä¸ªé”™è¯¯**ä¸æ˜¯æ¥è‡ªæˆ‘ä»¬çš„ä¸»æœåŠ¡**ï¼Œè€Œæ˜¯æ¥è‡ª**ä¸Šæ¸¸çš„æµ‹è¯•æœåŠ¡** (`test_services.py`)ã€‚

**é”™è¯¯æµç¨‹**ï¼š
1. MCPå®¢æˆ·ç«¯ â†’ æˆ‘ä»¬çš„ä¸»æœåŠ¡ (`proxy_call`)
2. æˆ‘ä»¬çš„ä¸»æœåŠ¡ â†’ ä¸Šæ¸¸æµ‹è¯•æœåŠ¡ (`/purchase`)
3. ä¸Šæ¸¸æµ‹è¯•æœåŠ¡ â†’ è¿”å›ç±»å‹éªŒè¯é”™è¯¯

## ğŸ¤” åˆç†æ€§åˆ†æ

### 1. **MCPå®¢æˆ·ç«¯çš„ä¼ é€’æ–¹å¼æ›´åˆç†** âœ…

**ä¼˜åŠ¿**ï¼š
- **å¯è¯»æ€§æ›´å¥½**: ç›´æ¥ä¼ é€’å¯¹è±¡ï¼Œç»“æ„æ¸…æ™°
- **ç±»å‹å®‰å…¨**: é¿å…äº†å­—ç¬¦ä¸²è§£æé”™è¯¯
- **æ ‡å‡†åšæ³•**: å¤§å¤šæ•°ç°ä»£APIéƒ½æœŸæœ›å¯¹è±¡æ ¼å¼
- **è°ƒè¯•å‹å¥½**: å¯ä»¥ç›´æ¥çœ‹åˆ°æ•°æ®ç»“æ„
- **å¼€å‘æ•ˆç‡**: å®¢æˆ·ç«¯ä¸éœ€è¦æ‰‹åŠ¨åºåˆ—åŒ–

**ç¤ºä¾‹**ï¼š
```python
# å®¢æˆ·ç«¯ä»£ç  - æ¸…æ™°æ˜“è¯»
payload = {
    "product_id": "FUND001",
    "amount": 1000,
    "payment_method": "online_banking",
    "risk_agreement": True
}

# è€Œä¸æ˜¯
payload = json.dumps({
    "product_id": "FUND001",
    "amount": 1000,
    "payment_method": "online_banking",
    "risk_agreement": True
})
```

### 2. **æˆ‘ä»¬ç¨‹åºçš„æœŸæœ›ä¸åˆç†** âŒ

**é—®é¢˜**ï¼š
- è¦æ±‚å®¢æˆ·ç«¯å°†å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œå¢åŠ äº†å¤æ‚æ€§
- å®¹æ˜“äº§ç”Ÿè§£æé”™è¯¯
- ä¸ç¬¦åˆç°ä»£APIè®¾è®¡æ ‡å‡†
- å¢åŠ äº†å®¢æˆ·ç«¯çš„å¼€å‘è´Ÿæ‹…

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. **æ­£ç¡®çš„åšæ³•**ï¼šè®©ç¨‹åºæ”¯æŒå¯¹è±¡æ ¼å¼

æˆ‘ä»¬çš„ç¨‹åºåº”è¯¥èƒ½å¤Ÿå¤„ç†ä¸¤ç§æ ¼å¼ï¼š
- **å¯¹è±¡æ ¼å¼**ï¼ˆæ¨èï¼‰
- **å­—ç¬¦ä¸²æ ¼å¼**ï¼ˆå‘åå…¼å®¹ï¼‰

### 2. **ä»£ç ä¿®æ”¹**

åœ¨ `main.py` çš„ `proxy_call` å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†æ­£ç¡®çš„å¤„ç†é€»è¾‘ï¼š

```python
# å¤„ç†å­—ç¬¦ä¸²æ ¼å¼çš„JSONå‚æ•°
if isinstance(params, str):
    try:
        import json as json_lib
        params = json_lib.loads(params)
    except:
        pass  # å¦‚æœè§£æå¤±è´¥ï¼Œä¿æŒåŸå€¼

if isinstance(json, str):
    try:
        import json as json_lib
        json = json_lib.loads(json)
    except:
        pass  # å¦‚æœè§£æå¤±è´¥ï¼Œä¿æŒåŸå€¼
```

### 3. **å‚æ•°å¤„ç†é€»è¾‘**

```python
# æ”¯æŒä¸¤ç§æ ¼å¼
if isinstance(json, dict):
    # å¯¹è±¡æ ¼å¼ï¼šç›´æ¥ä½¿ç”¨
    json_data = json
elif isinstance(json, str):
    # å­—ç¬¦ä¸²æ ¼å¼ï¼šå°è¯•è§£æ
    try:
        json_data = json_lib.loads(json)
    except:
        json_data = json
else:
    json_data = json
```

## âœ… å½“å‰çŠ¶æ€

### 1. **ç¨‹åºå·²ç»æ”¯æŒå¯¹è±¡æ ¼å¼**
- âœ… å¯ä»¥æ¥æ”¶å¯¹è±¡æ ¼å¼çš„JSONå‚æ•°
- âœ… å¯ä»¥æ¥æ”¶å­—ç¬¦ä¸²æ ¼å¼çš„JSONå‚æ•°
- âœ… è‡ªåŠ¨å¤„ç†æ ¼å¼è½¬æ¢

### 2. **é”™è¯¯åŸå› **
çœŸæ­£çš„é”™è¯¯å¯èƒ½æ¥è‡ªï¼š
- ä¸Šæ¸¸æœåŠ¡çš„å‚æ•°éªŒè¯
- ç¼ºå°‘å¿…éœ€å­—æ®µï¼ˆå¦‚ `user_id`ï¼‰
- å­—æ®µç±»å‹ä¸åŒ¹é…

## ğŸ”§ å»ºè®®å’Œæœ€ä½³å®è·µ

### 1. **MCPå®¢æˆ·ç«¯è®¾è®¡**
```python
# æ¨èï¼šç›´æ¥ä¼ é€’å¯¹è±¡
payload = {
    "service_id": 3,
    "method": "POST",
    "path": "/purchase",
    "json": {
        "product_id": "FUND001",
        "user_id": "USER123",  # æ³¨æ„ï¼šè¿™æ˜¯å¿…éœ€å­—æ®µ
        "amount": 1000,
        "payment_method": "online_banking",
        "risk_agreement": True
    }
}

# ä¸æ¨èï¼šåºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²
payload = {
    "service_id": 3,
    "method": "POST",
    "path": "/purchase",
    "json": json.dumps({...})
}
```

### 2. **APIè®¾è®¡åŸåˆ™**
- **æ¥å—å¯¹è±¡æ ¼å¼**: æ›´ç°ä»£ã€æ›´æ˜“ç”¨
- **å‘åå…¼å®¹**: æ”¯æŒå­—ç¬¦ä¸²æ ¼å¼
- **ç±»å‹å®‰å…¨**: ä½¿ç”¨å¼ºç±»å‹éªŒè¯
- **é”™è¯¯å¤„ç†**: æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

### 3. **æµ‹è¯•å»ºè®®**
```bash
# æµ‹è¯•å¯¹è±¡æ ¼å¼ï¼ˆæ¨èï¼‰
curl -X POST http://127.0.0.1:8000/proxy \
  -H "Content-Type: application/json" \
  -d '{
    "method": "POST",
    "path": "/purchase",
    "service_id": 3,
    "json": {
      "product_id": "FUND001",
      "user_id": "TEST_USER",
      "amount": 1000,
      "payment_method": "online_banking",
      "risk_agreement": true
    }
  }'
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä»£ç†è°ƒç”¨è®¾è®¡è¯´æ˜](PROXY_CALL_DESIGN.md)
- [Headers å­—æ®µé—®é¢˜ä¿®å¤è¯´æ˜](HEADERS_SAVE_FIX.md)
- [æµ‹è¯•æœåŠ¡ä»£ç ](test_services.py)
- [ä¸»æœåŠ¡ä»£ç ](main.py)

## ğŸ¯ æ€»ç»“

1. **MCPå®¢æˆ·ç«¯ä¼ é€’å¯¹è±¡æ ¼å¼æ˜¯æ­£ç¡®ä¸”åˆç†çš„åšæ³•**
2. **æˆ‘ä»¬çš„ç¨‹åºå·²ç»æ”¯æŒè¿™ç§æ ¼å¼**
3. **çœŸæ­£çš„é”™è¯¯å¯èƒ½æ¥è‡ªä¸Šæ¸¸æœåŠ¡çš„å‚æ•°éªŒè¯**
4. **å»ºè®®æ£€æŸ¥æ˜¯å¦ç¼ºå°‘å¿…éœ€å­—æ®µï¼ˆå¦‚ `user_id`ï¼‰**
5. **ç¨‹åºè®¾è®¡åº”è¯¥ä¼˜å…ˆæ”¯æŒå¯¹è±¡æ ¼å¼ï¼ŒåŒæ—¶ä¿æŒå‘åå…¼å®¹æ€§**
