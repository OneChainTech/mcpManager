# MCP金融服务管理平台 - 系统架构

本文档详细描述了MCP金融服务管理平台的系统架构、技术选型和设计决策。

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        MCP 客户端层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   MCP CLI   │  │  MCP GUI    │  │  MCP SDK    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      FastAPI 应用层                              │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    主应用 (main.py)                        │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │ │
│  │  │   MCP集成   │  │   API路由   │  │  中间件     │        │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘        │ │
│  └─────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  服务管理API                               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │ │
│  │  │   CRUD API  │  │  管理页面   │  │  配置管理   │        │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘        │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      业务逻辑层                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  MCP服务管理器                              │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │ │
│  │  │  服务注册   │  │  服务发现   │  │  服务调用   │        │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘        │ │
│  └─────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    代理服务                                 │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │ │
│  │  │  请求转发   │  │  响应处理   │  │  错误处理   │        │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘        │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据访问层                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    SQLModel ORM                            │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │ │
│  │  │  数据模型   │  │  查询构建   │  │  事务管理   │        │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘        │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据存储层                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    SQLite 数据库                           │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │ │
│  │  │  服务配置   │  │  系统配置   │  │  操作日志   │        │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘        │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      上游服务层                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ 服务A       │  │ 服务B       │  │ 服务C       │            │
│  │ (Port:9001) │  │ (Port:9002) │  │ (Port:9003) │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

## 🔧 技术栈

### 后端框架
- **FastAPI**: 现代、快速的Web框架，支持异步编程
- **Uvicorn**: 轻量级ASGI服务器，高性能异步处理
- **SQLModel**: 基于Pydantic的ORM，类型安全的数据操作

### MCP协议支持
- **fastapi-mcp**: 将FastAPI应用暴露为MCP服务器的库
- **MCP协议**: 模型上下文协议，支持工具调用和流式响应

### 数据库
- **SQLite**: 轻量级文件数据库，适合开发和中小型部署
- **SQLModel**: 类型安全的ORM，支持Pydantic验证

### 前端
- **Tailwind CSS**: 实用优先的CSS框架，快速构建现代化UI
- **Jinja2**: Python模板引擎，服务端渲染

### HTTP客户端
- **httpx**: 现代化的HTTP客户端，支持同步和异步操作

## 📊 数据模型设计

### 核心实体

#### 1. UpstreamService (上游服务)
```python
class UpstreamService(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    name: str                    # 服务名称，唯一标识
    summary: str                 # 服务描述
    url: str                     # 服务基础URL
    service_path: str            # 服务路径
    method: str                  # HTTP方法 (GET/POST)
    request_params: dict | None  # 请求参数定义
    response_params: dict | None # 响应参数定义
```

#### 2. AppConfig (应用配置)
```python
class AppConfig(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    default_timeout_seconds: float = Field(default=15.0)
```

### 数据关系
- 一个应用可以有多个上游服务
- 每个上游服务有唯一的配置信息
- 配置信息支持动态更新

## 🔄 核心流程

### 1. 服务注册流程
```
用户输入 → 参数验证 → 数据持久化 → 返回服务信息
    ↓           ↓           ↓           ↓
  表单提交    Pydantic     SQLite      JSON响应
```

### 2. 服务调用流程
```
MCP请求 → 参数解析 → 服务查找 → 代理调用 → 响应处理
    ↓         ↓         ↓         ↓         ↓
  工具调用   验证参数   数据库查询   HTTP请求   结果返回
```

### 3. 错误处理流程
```
异常发生 → 错误分类 → 日志记录 → 用户友好的错误响应
    ↓         ↓         ↓           ↓
  系统异常   类型判断   详细记录    标准格式
```

## 🚀 性能优化

### 1. 异步处理
- 使用FastAPI的异步特性
- 异步HTTP客户端调用上游服务
- 非阻塞的数据库操作

### 2. 连接池
- HTTP客户端连接复用
- 数据库连接池管理
- 资源自动清理

### 3. 缓存策略
- 服务配置缓存
- 响应结果缓存（可选）
- 连接状态缓存

## 🔒 安全设计

### 1. 输入验证
- Pydantic模型验证
- 参数类型检查
- SQL注入防护

### 2. 错误处理
- 不暴露敏感信息
- 标准化的错误响应
- 详细的日志记录

### 3. 访问控制
- 当前版本无认证（开发模式）
- 生产环境建议添加JWT认证
- API限流和频率控制

## 📈 扩展性设计

### 1. 水平扩展
- 无状态设计，支持多实例部署
- 数据库可以独立部署
- 负载均衡友好

### 2. 垂直扩展
- 模块化的代码结构
- 插件化的服务管理
- 配置驱动的功能开关

### 3. 集成能力
- 标准化的MCP协议
- RESTful API设计
- 支持多种数据格式

## 🧪 测试策略

### 1. 单元测试
- 服务管理器测试
- 数据模型测试
- 工具函数测试

### 2. 集成测试
- API端点测试
- 数据库操作测试
- MCP协议测试

### 3. 端到端测试
- 完整流程测试
- 用户界面测试
- 性能压力测试

## 📊 监控和日志

### 1. 应用监控
- 健康检查端点
- 性能指标收集
- 错误率统计

### 2. 日志管理
- 结构化日志格式
- 不同级别的日志
- 日志轮转和清理

### 3. 告警机制
- 服务异常告警
- 性能阈值告警
- 资源使用告警

## 🚀 部署架构

### 开发环境
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   开发机    │    │   主服务    │    │   测试服务  │
│             │◄──►│  (Port:8000)│◄──►│  (Port:9001)│
└─────────────┘    └─────────────┘    └─────────────┘
```

### 生产环境
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  负载均衡器  │    │  应用集群    │    │  数据库集群  │
│   (Nginx)   │◄──►│  (多实例)   │◄──►│  (主从)     │
└─────────────┘    └─────────────┘    └─────────────┘
```

## 🔮 未来规划

### 1. 功能增强
- 支持更多HTTP方法
- 添加WebSocket支持
- 实现服务发现机制

### 2. 性能提升
- 引入Redis缓存
- 支持异步任务队列
- 实现连接池优化

### 3. 运维支持
- 添加Prometheus指标
- 实现分布式追踪
- 支持容器化部署

## 📚 参考资料

- [FastAPI 官方文档](https://fastapi.tiangolo.com/)
- [MCP 协议规范](https://modelcontextprotocol.io/)
- [SQLModel 文档](https://sqlmodel.tiangolo.com/)
- [异步编程最佳实践](https://docs.python.org/3/library/asyncio.html)
